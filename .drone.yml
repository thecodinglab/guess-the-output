---
kind: pipeline
type: kubernetes
name: publish-backend

steps:
  - name: publish
    image: plugins/docker
    settings:
      context: backend
      dockerfile: backend/Dockerfile
      registry: ghcr.io
      repo: ghcr.io/thecodinglab/guess-the-output/backend
      tags: latest
      username:
        from_secret: github_username
      password:
        from_secret: github_token

---
kind: pipeline
type: ssh
name: deploy

server:
  host: 185.220.157.253
  user: ubuntu
  ssh_key:
    from_secret: deploy_key

steps:
  - name: deploy
    commands:
      - cd config
      - docker compose pull
      - docker compose up -d
    environment:
      HOME: /home/ubuntu

depends_on:
  - publish-backend

---
kind: signature
hmac: 7700f429ab380a2c088a259db66c8c1a0a944a0ca85bf679fc3170344da272ae

...
